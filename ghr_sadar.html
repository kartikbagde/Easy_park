<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ParkSmart — GH Raisoni Sadar Campus</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/ghr_wadi.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
  <header class="navbar">
    <div class="nav-logo">
      <img src="{{ url_for('static', filename='images/parksmartlogo.jpeg') }}" alt="ParkSmart Logo" class="logo-img">
      <h1>ParkSmart</h1>
    </div>
    <ul class="nav-links">
      <li><a href="/">Home</a></li>
      <li><a href="#faq">FAQs</a></li>
      <li><a href="#">About Us</a></li>
      <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
    </ul>
  </header>

  <section class="page-header">
    <h2>GH Raisoni Sadar Campus — Student Parking Slots</h2>
  </section>

  <main class="main-container">
    <div class="map-container">
      <div id="map"></div>
    </div>
    <div class="slots-container">
      <div id="controls">
        <button id="minAllBtn" onclick="minimizeAll()">Minimize All</button>
        <button id="maxAllBtn" onclick="maximizeAll()">Maximize All</button>
      </div>
      <div id="slots"></div>
      <button id="bookBtn" onclick="bookSelectedSlot()" disabled>Book Selected Slot</button>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const campusName = "gh raisoni sadar";

    
    const studentParkingCoords = [
      [21.1531, 79.0847],
      [21.1531, 79.0855],
      [21.1524, 79.0855],
      [21.1524, 79.0847]
    ];

    const map = L.map('map', { minZoom: 17, maxZoom: 22 }).setView([21.1528, 79.0851], 20);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    L.polygon(studentParkingCoords, { color: '#00b300', weight: 2, fillOpacity: 0.05 }).addTo(map);

    const rows = 10, cols = 14;
    const latStart = studentParkingCoords[0][0], latEnd = studentParkingCoords[2][0];
    const lonStart = studentParkingCoords[0][1], lonEnd = studentParkingCoords[2][1];

    const markers = [];
    const slotData = [];

    
    for (let i = 0; i < rows; i++) {
      for (let j = 0; j < cols; j++) {
        const lat = latStart + i * (latEnd - latStart) / rows;
        const lon = lonStart + j * (lonEnd - lonStart) / cols;
        const slotId = `R${i+1}C${j+1}`;

        const marker = L.circleMarker([lat, lon], { radius: 3, color: '#ff0000', fillOpacity: 1 }).addTo(map);
        marker.bindPopup(`
          <b>Parking Slot</b><br>${slotId}<br>
          <button class="popup-btn" data-slot="${slotId}">Book This Spot</button>
        `, { autoClose: false, closeOnClick: false });

        markers.push(marker);
        slotData.push({ id: slotId, marker: marker, booked: false });
      }
    }

   
    fetch("/get_booked_slots", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ campus: campusName })
    }).then(res => res.json()).then(bookedSlots => {
      bookedSlots.forEach(slotId => {
        const slot = slotData.find(s => s.id === slotId);
        if (slot) {
          slot.booked = true;
          slot.marker.setStyle({ color: '#00b300' });
        }
      });
      showSlots();
    });

    function showSlots() {
      const slotsDiv = document.getElementById('slots');
      slotsDiv.innerHTML = "";
      slotData.forEach(slot => {
        const slotEl = document.createElement('div');
        slotEl.className = 'slot';
        slotEl.id = slot.id;
        slotEl.innerHTML = `
          <div class='slot-header'>
            ${slot.id} <button class='toggle-btn'>➕</button>
          </div>
          <div class='slot-details'>
            <p>Size: Standard</p>
            <p>Near Entrance: Yes</p>
            <p>Status: ${slot.booked ? "Booked" : "Available"}</p>
          </div>
        `;
        slotEl.onclick = () => selectSlot(slotEl);
        slotEl.querySelector(".toggle-btn").onclick = e => { e.stopPropagation(); toggleSlot(slotEl); };
        slotsDiv.appendChild(slotEl);
      });
    }

    let selectedSlot = null;
    function selectSlot(element) {
      document.querySelectorAll(".slot").forEach(s => s.classList.remove("selected"));
      element.classList.add("selected");
      selectedSlot = element.id;
      const slot = slotData.find(s => s.id === selectedSlot);
      document.getElementById("bookBtn").disabled = slot && slot.booked;
      if (slot) map.panTo(slot.marker.getLatLng());
    }

    function toggleSlot(slotEl) {
      const details = slotEl.querySelector(".slot-details");
      const visible = details.style.display === "block";
      details.style.display = visible ? "none" : "block";
      slotEl.querySelector(".toggle-btn").textContent = visible ? "➕" : "➖";
    }

    function minimizeAll() {
      document.querySelectorAll(".slot-details").forEach(d => d.style.display = "none");
      document.querySelectorAll(".toggle-btn").forEach(b => b.textContent = "➕");
    }

    function maximizeAll() {
      document.querySelectorAll(".slot-details").forEach(d => d.style.display = "block");
      document.querySelectorAll(".toggle-btn").forEach(b => b.textContent = "➖");
    }

    function bookSlotAJAX(slotId) {
      fetch("/book_slot", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ slot_id: slotId, campus: campusName })
      }).then(res => res.json()).then(data => {
        alert(data.message);
        if (data.status === "success") {
          const slot = slotData.find(s => s.id === slotId);
          if (slot) {
            slot.booked = true;
            slot.marker.setStyle({ color: '#00b300' });
            const slotDiv = document.getElementById(slotId);
            slotDiv.querySelector(".slot-details p:last-child").innerText = "Status: Booked";
          }
        }
      });
    }

    function bookSelectedSlot() {
      if (selectedSlot) bookSlotAJAX(selectedSlot);
    }

    function bookMarkerSlot(slotId) {
      bookSlotAJAX(slotId);
      const slotDiv = document.getElementById(slotId);
      if (slotDiv) selectSlot(slotDiv);
    }

    
    map.on('popupopen', e => {
      const popupNode = e.popup.getElement();
      const btn = popupNode.querySelector(".popup-btn");
      if (btn) {
        btn.addEventListener("click", ev => {
          ev.stopPropagation();
          const slotId = btn.getAttribute("data-slot");
          bookMarkerSlot(slotId);
        });
      }
    });

    
    markers.forEach((marker, i) => {
      marker.on('click', () => {
        const slotDiv = document.getElementById(slotData[i].id);
        if (slotDiv) selectSlot(slotDiv);
      });
    });
  </script>
</body>
</html>
